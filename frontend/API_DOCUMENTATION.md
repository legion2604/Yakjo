# Yakjo API Documentation v1

–ë–∞–∑–æ–≤—ã–π URL: `https://api.yakjo.tj/v1`
–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: `application/json`
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: 
- **AccessToken**: `httpOnly` Cookie (TTL: 15 –º–∏–Ω—É—Ç).
- **RefreshToken**: `httpOnly` Cookie (TTL: 90 –¥–Ω–µ–π).

### WebSocket Auth
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Cookie (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).
- –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –∫–æ–¥–æ–º `4001` (Unauthorized). –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ HTTP –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.

### üõ°Ô∏è Security & CORS (Important)
–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã `httpOnly` cookies –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ:
1.  **Frontend**: –í –∑–∞–ø—Ä–æ—Å–∞—Ö (axios/fetch) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å `withCredentials: true` –∏–ª–∏ `credentials: 'include'`.
2.  **Backend (Production)**:
    - `Access-Control-Allow-Origin`: `https://frontend.yakjo.tj` (–ù–µ `*`!)
    - `Access-Control-Allow-Credentials`: `true`
    - **Cookie Settings**: `SameSite=None; Secure=true; Path=/; Domain=.yakjo.tj`
    - **Localhost Development**: `Secure=true` —Ç—Ä–µ–±—É–µ—Ç HTTPS. –ù–∞ localhost –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `SameSite=Lax` –∏–ª–∏ –ø–æ–¥–Ω–∏–º–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π HTTPS –ø—Ä–æ–∫—Å–∏.
    - –î–ª—è WebSocket `wss://` —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.

---

## üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Auth)

### 1. –û—Ç–ø—Ä–∞–≤–∫–∞ OTP –∫–æ–¥–∞ (`POST /auth/send-otp`)
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤—Ö–æ–¥–∞ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
> **Limit:** –ú–∞–∫—Å–∏–º—É–º 3 –∑–∞–ø—Ä–æ—Å–∞ –≤ 5 –º–∏–Ω—É—Ç (–∏–Ω–∞—á–µ `429 Too Many Requests`).

**Request Body (JSON):**
```json
{
  "phone": "+992900000000" // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (Intl format)
}
```

**Success Response (200 OK):**
```json
{
  "message": "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ",
  "expiresIn": 120 // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ–¥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
}
```

**Error Response (400 Bad Request):**
```json
{
  "status": "error",
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
  "code": "INVALID_PHONE"
}
```
**Rate Limit (429 Too Many Requests):**
```json
{
  "status": "error",
  "message": "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.",
  "code": "RATE_LIMIT_EXCEEDED"
}
```

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ –í—Ö–æ–¥ (`POST /auth/verify-otp`)
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç OTP –∫–æ–¥. –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–æ–≤—ã–π ‚Äî —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `isNewUser: true`. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `httpOnly` cookie `refreshToken`.

**Request Body (JSON):**
```json
{
  "phone": "+992900000000",
  "code": "1234" // 4 —Ü–∏—Ñ—Ä—ã
}
```

**Success Response (200 OK):** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `httpOnly` cookies `accessToken` –∏ `refreshToken`.
  ```json
  {
    "user": {
    "id": "user-uuid",
    "phone": "+992900000000",
    "isNewUser": true // –§–ª–∞–≥: –µ—Å–ª–∏ true -> —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /register
  }
}
```

**Error Response (401 Unauthorized):**
```json
{
  "status": "error",
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç–µ–∫",
  "code": "INVALID_OTP"
}
```
> **Security:** –ü–æ—Å–ª–µ 5 –Ω–µ–≤–µ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤–≤–æ–¥ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 10 –º–∏–Ω—É—Ç.

---

### 3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (`POST /auth/register`)
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`isNewUser: true`) –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è. –¢—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞/–∫—É–∫–∏.

**Request Body (JSON):**
```json
{
  "firstName": "–¢–∏–º—É—Ä", // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  "lastName": "–ê–ª–∏–µ–≤",  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  "birthDate": "1995-05-20", // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (YYYY-MM-DD)
  "gender": "male", // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ('male' | 'female')
  "bio": "–õ—é–±–ª—é –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å", // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (max 500 chars)
  "car": "Toyota Camry" // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π)
}
```

**Success Response (200 OK):**
```json
{
  "id": "user-uuid",
  "firstName": "–¢–∏–º—É—Ä",
  "lastName": "–ê–ª–∏–µ–≤",
  "isNewUser": false
}
```

---

### 4. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (`GET /auth/me`)
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Example URL:**
`GET /auth/me`

**Headers:**
- `Cookie: accessToken=...` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

**Success Response (200 OK):**
```json
{
  "id": "user-uuid",
  "phone": "+992900000000",
  "firstName": "–¢–∏–º—É—Ä",
  "lastName": "–ê–ª–∏–µ–≤",
  "avatarUrl": "https://...",
  "rating": 4.9,
  "ridesCount": 15,
  "whatsapp": "992900000000",
  "telegram": "t_aliev"
}
```

---

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (`POST /auth/refresh-token`)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø–∞—Ä—ã —Ç–æ–∫–µ–Ω–æ–≤, –∫–æ–≥–¥–∞ Access Token –∏—Å—Ç–µ–∫. –ß–∏—Ç–∞–µ—Ç Refresh Token –∏–∑ `httpOnly` cookie.

**Success Response (200 OK):**
```json
{ "message": "Tokens updated" }
```
*–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ `accessToken` –∏ `refreshToken` –≤ cookies.*

---

## üöó –ü–æ–µ–∑–¥–∫–∏ (Rides)

### 1. –ü–æ–∏—Å–∫ –ø–æ–µ–∑–¥–æ–∫ (`GET /rides/search`)

**Example URL:**
`GET /rides/search?from=–î—É—à–∞–Ω–±–µ&to=–•—É–¥–∂–∞–Ω–¥&date=2024-02-25&seats=1&sort=price_asc`

**Query Parameters (JSON):**
```json
{
  "from": "–î—É—à–∞–Ω–±–µ",
  "to": "–•—É–¥–∂–∞–Ω–¥",
  "date": "2024-02-25", // YYYY-MM-DD
  "seats": 1,           // Min 1
  "sort": "price_asc",  // 'price_asc' | 'price_desc' | 'time_asc'
  "page": 1,            // Optional (Default: 1)
  "limit": 10           // Optional (Max 50)
}
```

**Success Response (200 OK):**
```json
{
  "data": [
    {
      "id": "ride-uuid",
      "from": "–î—É—à–∞–Ω–±–µ",
      "to": "–•—É–¥–∂–∞–Ω–¥",
      "price": 120,
      "departureTime": "2024-02-25T08:00:00Z", // UTC (ISO 8601)
      "availableSeats": 3,
      "driver": {
        "id": "driver-uuid",
        "firstName": "–ê–ª–∏—à–µ—Ä",
        "rating": 4.8,
        "avatarUrl": "..."
      },
      "car": "Toyota Camry 2020",
      "features": ["air_conditioner", "music"]
    }
  ],
  "meta": {
    "total": 5,
    "page": 1,
    "limit": 10
  }
}
```

---

### 2. –î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏ (`GET /rides/:id`)
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–µ–∑–¥–∫–µ.

**Example URL:**
`GET /rides/550e8400-e29b-41d4-a716-446655440000`

**Success Response (200 OK):**
```json
{
  "id": "ride-uuid",
  "from": "–î—É—à–∞–Ω–±–µ",
  "to": "–•—É–¥–∂–∞–Ω–¥",
  "description": "–ï–¥—É –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –º–æ–≥—É –∑–∞–±—Ä–∞—Ç—å —Å –í–æ–¥–æ–Ω–∞—Å–æ—Å–Ω–æ–π",
  "price": 120,
  "totalSeats": 4,
  "availableSeats": 3,
  "departureTime": "2024-02-25T08:00:00Z",
  "driver": {
    "id": "driver-uuid",
    "firstName": "–ê–ª–∏—à–µ—Ä",
    "lastName": "–í–∞–ª–∏–µ–≤",
    "rating": 4.8,
    "contacts": { // –û–±—ä–µ–∫—Ç –∏–ª–∏ null (–µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
       "hidden": true // –§–ª–∞–≥ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å"
    }
  }
}
```

---

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (`GET /rides/:id/contacts`)
–ü–æ–∑–≤–æ–ª—è–µ—Ç —É–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤–æ–¥–∏—Ç–µ–ª—è. –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

**Example URL:**
`GET /rides/550e8400-e29b-41d4-a716-446655440000/contacts`

**Success Response (200 OK):**
```json
{
  "phone": "+992900112233",
  "whatsapp": "992900112233",
  "telegram": "alisher_v"
}
```

---

### 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏ (`POST /rides`)
–ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è.

**Request Body (JSON):**
```json
{
  "from": "–î—É—à–∞–Ω–±–µ",
  "to": "–•—É–¥–∂–∞–Ω–¥",
  "departureTime": "2024-02-25T08:00:00Z", // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (ISO 8601 UTC)
  "price": 120, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–¶–µ–Ω–∞ –∑–∞ –º–µ—Å—Ç–æ)
  "totalSeats": 4, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–í—Å–µ–≥–æ –º–µ—Å—Ç –≤ –º–∞—à–∏–Ω–µ)
  "description": "–ó–∞–±–µ—Ä—É —Å —Ü–µ–Ω—Ç—Ä–∞" // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**Success Response (201 Created):**
```json
{
  "id": "new-ride-uuid",
  "status": "created"
}
```

**Errors:**
- `400 Bad Request`: Validation error (seats < 1, past date).
- `403 Forbidden`: Driver banned or limit reached (max 3 active rides).
- `409 Conflict`: –í–æ–¥–∏—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç –ø–æ–µ–∑–¥–∫—É –≤ —ç—Ç–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ.

---

## üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Users)

### 1. –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (`GET /users/:id`)
–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è. –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –¥–µ—Ç–∞–ª–∏ —Å–∫—Ä—ã—Ç—ã.

**Example URL:**
`GET /users/550e8400-e29b-41d4-a716-446655440000`

**Success Response (200 OK):**
```json
{
  "id": "user-uuid",
  "firstName": "–ê–ª–∏—à–µ—Ä",
  "createdAt": "2023-10-10",
  "rating": 4.8,
  "reviewCount": 12,
  "reviews": [ // –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º []
    {
      "id": "review-1",
      "author": "–ú–∞–¥–∏–Ω–∞",
      "rating": 5,
      "comment": "–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å, –¥–æ–µ—Ö–∞–ª–∏ –±—ã—Å—Ç—Ä–æ!",
      "date": "2024-01-15"
    }
  ]
}
```

---

### 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (`PUT /users/me`)
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

**Request Body (JSON):**
```json
{
  "firstName": "–¢–∏–º—É—Ä",      // Min 2 chars
  "bio": "–û —Å–µ–±–µ...",        // Max 500 chars
  "whatsapp": "992933333333", // Min 9 digits
  "telegram": "username"     // Without @
}
```
**Errors:**
- `400 Bad Request`: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (bio > 500, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞).


---

### 3. –û—Ü–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`POST /users/:id/rate`)
–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –≤–æ–¥–∏—Ç–µ–ª—é –∏–ª–∏ –ø–∞—Å—Å–∞–∂–∏—Ä—É.
> **Note:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Ü–µ–Ω–∏–≤–∞–ª —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, —Å—Ç–∞—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–ø–æ–ª–µ `updatedAt` –∏–∑–º–µ–Ω–∏—Ç—Å—è). –ù–µ–ª—å–∑—è –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è.

**Request Body (JSON):**
```json
{
  "rating": 5, // 1-5
  "comment": "–û—Ç–ª–∏—á–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞!" // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

**Success Response (200 OK):**
```json
{ "message": "Rating submitted" }
```

## üí¨ –ß–∞—Ç (WebSocket Only)

–í—Å—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω–æ–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- **Production URL:** `wss://api.yakjo.tj/v1/ws` (TLS Required)
- **Dev URL:** `ws://localhost:8080/v1/ws`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** Cookie `httpOnly`.
- **Fallback:** `?token=JWT` (**–í–ù–ò–ú–ê–ù–ò–ï: –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ!** –¢–æ–∫–µ–Ω –≤–∏–¥–µ–Ω –≤ history/logs. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è dev/mobile).

---

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (Models)

#### User (Short)
```json
{
  "id": "uuid",
  "firstName": "string",
  "lastName": "string",
  "avatarUrl": "string | null",
  "online": "boolean"
}
```

#### Message
```json
{
  "id": "uuid",
  "chatId": "uuid",
  "senderId": "uuid",
  "content": "string",
  "createdAt": "ISO8601",
  "isRead": "boolean"
}
```

#### Chat
```json
{
  "id": "uuid",
  "partner": { "User" },
  "lastMessage": { "Message" },
  "unreadCount": "int"
}
```

---

### 3. –ö–æ–º–∞–Ω–¥—ã (Client -> Server)

–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –æ–±—ä–µ–∫—Ç—ã —Å –ø–æ–ª–µ–º `type`.

#### 3.1 –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
```json
{
  "type": "get_chats"
}
```

#### 3.2 –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
```json
{
  "type": "get_history",
  "chatId": "550e8400-e29b-41d4-a716-446655440000",
  "limit": 50,  // (Optional) Max 100
  "offset": 0   // (Optional) –°–¥–≤–∏–≥ –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
}
```

#### 3.3 –ù–∞—á–∞—Ç—å —á–∞—Ç (–∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–µ–∑–¥–∫–∏ –∏ –Ω–∞–∂–∏–º–∞–µ–º "–ù–∞–ø–∏—Å–∞—Ç—å". –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ –µ—Å—Ç—å ‚Äî –≤–µ—Ä–Ω–µ—Ç –µ–≥–æ ID, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π.
```json
{
  "type": "start_chat",
  "userId": "uuid-driver-id" // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏–º –æ–±—â–∞—Ç—å—Å—è
}
```

#### 3.4 –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
```json
{
  "type": "send_message",
  "chatId": "550e8400-e29b-41d4-a716-446655440000",
  "text": "–ü—Ä–∏–≤–µ—Ç! –ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?" // –ú–∞–∫—Å–∏–º—É–º 4096 —Å–∏–º–≤–æ–ª–æ–≤
}
```

#### 3.5 –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (Mark as Read)
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª —á–∞—Ç –∏–ª–∏ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏–ª –¥–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
```json
{
  "type": "read_messages",
  "chatId": "550e8400-e29b-41d4-a716-446655440000",
  "messageIds": ["uuid1", "uuid2"] // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ chatId, —á—Ç–æ–±—ã –ø–æ–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
}
```

#### 3.6 –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –ü–æ–¥–≥—Ä—É–∑–∫–∞ (Pagination Advice)
–î–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `offset` —Ä–∞–≤–Ω—ã–π —Ç–µ–∫—É—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
**–ü—Ä–∏–º–µ—Ä:**
1. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: `get_history` (limit: 50, offset: 0) -> –ü–æ–ª—É—á–∏–ª–∏ 50 —Å–æ–æ–±—â–µ–Ω–∏–π.
2. –°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö -> `get_history` (limit: 50, offset: 50) -> –ü–æ–ª—É—á–∏–ª–∏ –µ—â–µ 50 (–±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã—Ö).

#### 3.7 –†–µ–∫–æ–Ω–Ω–µ–∫—Ç (Reconnection Handling)
- –ü—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`onclose`) –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.
- **Backoff:** –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (1s, 2s, 4s, ... max 30s).
- **Max Attempts:** –õ–∏–º–∏—Ç 10-20 —Ä–∞–∑ (–∏–ª–∏ 5 –º–∏–Ω—É—Ç). –î–∞–ª–µ–µ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É "–ù–µ—Ç —Å–µ—Ç–∏".
- –ï—Å–ª–∏ `onclose` –∫–æ–¥ `4001` (Auth), **—Å–Ω–∞—á–∞–ª–∞** –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω (`POST /auth/refresh-token`). –ï—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è (401) ‚Äî —Ä–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

### 4. –°–æ–±—ã—Ç–∏—è (Server -> Client)

–°–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç JSON –æ–±—ä–µ–∫—Ç—ã —Å –ø–æ–ª–µ–º `type`.

#### 4.1 –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (`chats_list`)
–ü—Ä–∏—Ö–æ–¥–∏—Ç –≤ –æ—Ç–≤–µ—Ç –Ω–∞ `get_chats`.
```json
{
  "type": "chats_list",
  "data": [
    {
      "id": "chat-uuid-1",
      "partner": {
        "id": "partner-uuid",
        "firstName": "–ê–ª–∏—à–µ—Ä",
        "avatarUrl": "/uploads/avatar1.jpg"
      },
      "lastMessage": {
        "content": "–ë—É–¥—É —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç",
        "createdAt": "2024-02-21T10:05:00Z"
      },
      "unreadCount": 2
    }
  ]
}
```

#### 4.2 –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (`chat_history`)
–ü—Ä–∏—Ö–æ–¥–∏—Ç –≤ –æ—Ç–≤–µ—Ç –Ω–∞ `get_history`.
```json
{
  "type": "chat_history",
  "chatId": "chat-uuid-1",
  "data": [
    {
      "id": "msg-uuid-10",
      "senderId": "partner-uuid",
      "content": "–ü—Ä–∏–≤–µ—Ç!",
      "createdAt": "2024-02-21T10:00:00Z",
      "isRead": true
    }
  ],
  "hasMore": true // –ï—Å—Ç—å –ª–∏ –µ—â–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏
}
```

#### 4.3 –ß–∞—Ç –æ—Ç–∫—Ä—ã—Ç/—Å–æ–∑–¥–∞–Ω (`chat_opened`)
–ü—Ä–∏—Ö–æ–¥–∏—Ç –≤ –æ—Ç–≤–µ—Ç –Ω–∞ `start_chat`.
```json
{
  "type": "chat_opened",
  "chat": {
    "id": "chat-uuid-new",
    "partner": { ... } // –î–∞–Ω–Ω—ã–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
  }
}
```

#### 4.4 –ù–æ–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`new_message`)
–ü—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.
```json
{
  "type": "new_message",
  "chatId": "chat-uuid-1",
  "message": {
    "id": "msg-uuid-11",
    "senderId": "partner-uuid",
    "content": "–Ø –ø–æ–¥—ä–µ—Ö–∞–ª",
    "createdAt": "2024-02-21T10:10:00Z"
  }
}
```

#### 4.5 –û—à–∏–±–∫–∞ (`error`)
–ü—Ä–∏—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω).

**–ü—Ä–∏–º–µ—Ä (start_chat —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º userId):**
```json
{
  "type": "error",
  "message": "User not found",
  "code": "USER_NOT_FOUND",
  "originalRequestType": "start_chat",
  "details": { "userId": "invalid-uuid" }
}
```

**–ü—Ä–∏–º–µ—Ä (get_history –¥–ª—è —á—É–∂–æ–≥–æ —á–∞—Ç–∞):**
```json
{
  "type": "error",
  "message": "Access denied",
  "code": "ACCESS_DENIED",
  "originalRequestType": "get_history"
}
```

## üìà –û—à–∏–±–∫–∏ (Error Handling)

### HTTP –û—à–∏–±–∫–∏
- `429 Too Many Requests`: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (OTP, Rides create).
- `400 Bad Request`: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
- `401 Unauthorized`: –¢–æ–∫–µ–Ω –Ω–µ–≤–µ—Ä–µ–Ω/–∏—Å—Ç–µ–∫.
- `403 Forbidden`: –ù–µ—Ç –ø—Ä–∞–≤.
- `404 Not Found`: –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.

### WebSocket –û—à–∏–±–∫–∏
–ö–æ–¥ –æ—à–∏–±–∫–∏ (`code`) ‚Äî —Å—Ç—Ä–æ–∫–∞.
- `USER_NOT_FOUND`: (start_chat) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.
- `ACCESS_DENIED`: (mark_read, get_history) –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.
- `INVALID_PAYLOAD`: –ù–µ–≤–µ—Ä–Ω—ã–π JSON.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (HTTP):**
```json
{
  "status": "error",
  "message": "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.",
  "code": "RATE_LIMIT_EXCEEDED"
}
```

**–ü—Ä–∏–º–µ—Ä (403 Forbidden):**
```json
{
  "status": "error",
  "message": "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —á—É–∂—É—é –ø–æ–µ–∑–¥–∫—É",
  "code": "ACCESS_DENIED"
}
```

**–ü—Ä–∏–º–µ—Ä (500 Internal Error):**
```json
{
  "status": "error",
  "message": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
  "code": "INTERNAL_SERVER_ERROR"
}
```
